============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-9.0.2, pluggy-1.6.0
rootdir: /home/dvx3/Workspace/PQVPN
configfile: pyproject.toml
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 10 items

tests/test_2node_integration.py .Layered ChaCha crypto test completed
.Traffic shaping: sent 10 packets in 0.00s
..Crypto benchmark: 10 KEM ops in 0.00s
.FPadding analysis: mean=54.9, std=29.9, variation=0.62
Pattern analysis: 60 original detections, 60 after padding
Size variance: original=14.7, padded=883.7
.Crypto pattern analysis: 75/75 unique ciphertext prefixes
.Network flow analysis: 4 unique flows
  network->session: avg 96.0 bytes
  session->crypto: avg 96.0 bytes
  network->traffic_shaper: avg 100.0 bytes
  anti_dpi->network: avg 98.0 bytes
.Enhanced DPI analysis: 5 issues before, 3 after obfuscation
.

=================================== FAILURES ===================================
_______________ Test2NodeIntegration.test_censorship_simulation ________________

self = <test_2node_integration.Test2NodeIntegration object at 0x7f6f4629d040>
node_configs = ({'discovery': {'enabled': False}, 'keys': {'dir': '/tmp/tmpg6l7jmtr/keys1', 'persist': False}, 'network': {'bind_host.../keys2', 'persist': False}, 'network': {'bind_host': '127.0.0.1', 'listen_port': 9001}, 'peer': {'nickname': 'node2'}})

    @pytest.mark.asyncio
    async def test_censorship_simulation(self, node_configs):
        """Simulate censorship with mock DPI blocking and verify bypass."""
        config1, _ = node_configs
    
        node1 = await self.create_mock_node(config1)
    
        # Mock DPI blocker that blocks packets containing certain patterns
        class MockDPIBlocker:
            def __init__(self):
                self.blocked_patterns = [b'PQVPN_PROTOCOL']
    
            def is_blocked(self, packet):
                # In real DPI, it might inspect payload, but for test, assume padding hides it
                # For simulation, we'll assume that padded packets are not inspected deeply
                return b'PQVPN_PROTOCOL' in packet and len(packet) < 50  # Only block short packets with pattern
    
        dpi_blocker = MockDPIBlocker()
    
        # Test blocked packet
        blocked_packet = b"This is a PQVPN_PROTOCOL tunnel packet"
        assert dpi_blocker.is_blocked(blocked_packet)
    
        # Test evasion with padding
        evaded_packet = node1.anti_dpi.apply_padding(blocked_packet)
        # After padding, packet is longer, so not blocked
>       assert not dpi_blocker.is_blocked(evaded_packet)
E       AssertionError: assert not True
E        +  where True = is_blocked(b'\x00This is a PQVPN_PROTOCOL tunnel packet')
E        +    where is_blocked = <test_2node_integration.Test2NodeIntegration.test_censorship_simulation.<locals>.MockDPIBlocker object at 0x7f6f4622f230>.is_blocked

tests/test_2node_integration.py:360: AssertionError
=========================== short test summary info ============================
FAILED tests/test_2node_integration.py::Test2NodeIntegration::test_censorship_simulation
========================= 1 failed, 9 passed in 0.15s ==========================
