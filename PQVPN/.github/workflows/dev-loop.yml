name: Dev loop CI

on:
  push:
    branches:
      - main
      - 'dev/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_integration:
        description: 'Run heavy integration tests (true/false)'
        required: false
        default: 'false'

# Explicit permissions so the workflow can create issues and annotations when needed
permissions:
  contents: read
  issues: write
  security-events: write

concurrency:
  group: dev-loop-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.14'

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff (auto-fix)
        run: |
          ruff check . --fix || true

      - name: Check style
        run: |
          ruff check .

  unit-tests:
    name: Unit tests (pytest)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install pytest; fi

      - name: Run tests
        run: |
          pytest -q --junitxml=pytest-report.xml || true

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: pytest-report.xml

  security-scan:
    name: Security scan (pip-audit + bandit)
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit

      - name: Run pip-audit
        id: pip_audit
        run: |
          if [ -f requirements.txt ]; then pip-audit -r requirements.txt -f json -o pip_audit.json || true; else pip-audit -f json -o pip_audit.json || true; fi
          echo "pip_audit_path=pip_audit.json" >> $GITHUB_OUTPUT

      - name: Run bandit
        id: bandit
        run: |
          bandit -r . -f json -o bandit.json || true
          echo "bandit_path=bandit.json" >> $GITHUB_OUTPUT

      - name: Create Issue for findings
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const pipPath = 'pip_audit.json';
            const banditPath = 'bandit.json';
            let pip = null;
            let band = null;
            if (fs.existsSync(pipPath)) {
              try { pip = JSON.parse(fs.readFileSync(pipPath)); } catch(e) { pip = null }
            }
            if (fs.existsSync(banditPath)) {
              try { band = JSON.parse(fs.readFileSync(banditPath)); } catch(e) { band = null }
            }

            const vulnerabilities = (pip && pip.vulnerabilities) ? pip.vulnerabilities : [];
            const banditIssues = (band && band.results) ? band.results : [];

            if (vulnerabilities.length === 0 && banditIssues.length === 0) {
              console.log('No security findings.');
              return;
            }

            const bodyParts = [];
            if (vulnerabilities.length) {
              bodyParts.push('## pip-audit findings\n');
              bodyParts.push('```json\n' + JSON.stringify(vulnerabilities, null, 2) + '\n```');
            }
            if (banditIssues.length) {
              bodyParts.push('\n## bandit findings\n');
              bodyParts.push('```json\n' + JSON.stringify(banditIssues, null, 2) + '\n```');
            }

            const title = `Automated security scan findings (${vulnerabilities.length + banditIssues.length} issues)`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: bodyParts.join('\n\n'),
              labels: ['security', 'automated']
            });

  codeql:
    name: CodeQL analysis
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Run CodeQL
        uses: github/codeql-action/analyze@v3

  integration:
    name: Integration tests (optional/heavy)
    runs-on: ubuntu-latest
    needs: [unit-tests, security-scan, codeql]
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_integration == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Run integration tests
        run: |
          # Placeholder: customize integration/test orchestration (docker, services) as needed
          pytest -q tests -k integration || true

outputs:
  status: ${{ job.unit-tests.outcome }}
