name: Auto-enable auto-merge for Dependabot PRs

on:
  pull_request_target:
    types: [opened, reopened, synchronize, labeled]

jobs:
  enable-automerge:
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge for Dependabot PR
        uses: actions/github-script@v6
        with:
          script: |
            const prNodeId = context.payload.pull_request.node_id;
            try {
              const res = await github.graphql(`mutation($prId: ID!){ enablePullRequestAutoMerge(input:{pullRequestId:$prId, mergeMethod:SQUASH}){ pullRequest { number } } }`, { prId: prNodeId });
              core.info(`Enabled auto-merge for PR #${res.enablePullRequestAutoMerge.pullRequest.number}`);
            } catch (e) {
              core.info(`Auto-merge enable failed: ${e.message}`);
              throw e;
            }
